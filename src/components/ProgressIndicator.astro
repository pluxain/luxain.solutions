---
import type { Size } from "@types";

type Props = {
  trackedId: string;
  max: number;
  class?: string;
  thickness?: Size;
};

const { class: className, max, trackedId, thickness = "base" } = Astro.props;
---

<astro-progress-indicator data-tracked-id={trackedId} data-max={max}>
  <hr
    id={`${trackedId}-count`}
    class:list={[
      `invisible border-danger`,
      { "border-4": thickness === "lg" },
      { "border-2": thickness === "base" },
      { border: thickness === "sm" },
      className,
    ]}
  />
</astro-progress-indicator>

<script>
  import {
    HTMLComponentElementNotFoundError,
    HTMLComponentPropError,
  } from "@libs/errors";

  class AstroProgressIndicator extends HTMLElement {
    connectedCallback() {
      const { max, trackedId } = this.dataset;

      // Prop validation
      // TODO: make a type guard for TS
      [
        ["max", max],
        ["trackedId", trackedId],
      ].forEach(([name, prop]) => {
        if (typeof prop === "undefined") {
          throw new HTMLComponentPropError(`${name} must be set`);
        }
      });

      const tracked = document.getElementById(trackedId!);
      if (tracked instanceof HTMLTextAreaElement) {
        const indicator = this.querySelector<HTMLHRElement>(
          `#${trackedId}-count`,
        );

        if (indicator === null) {
          throw new HTMLComponentElementNotFoundError(
            `HTMLElement with id ${trackedId}-count is required`,
          );
        }

        tracked.addEventListener("input", () => {
          const count = tracked.textLength;
          ["invisible"].forEach((cssClass) => {
            if (indicator.classList.contains(cssClass)) {
              indicator.classList.remove(cssClass);
            } else if (count == 0) {
              indicator.classList.add(cssClass);
            }
            this.setAttribute("title", count.toString());
            indicator.style.setProperty(
              "width",
              `${Math.min((count * 100) / +max!, 100)}%`,
            );
          });
        });
      }
    }
  }
  customElements.define("astro-progress-indicator", AstroProgressIndicator);
</script>
