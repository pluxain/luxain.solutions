#!/usr/bin/env sh

branch="$(git rev-parse --abbrev-ref HEAD)"

if [ "$branch" = "main" ]; then
  echo "$branch branch executing install and build"
  # TODO: Find a way to only run when package-lock.json is modified
  npm install

  # create folder structure for backup
  mkdir -p ./backup/client
  mkdir -p ./backup/server/logs

  # save .htaccess for NodeJs application
  mv ./dist/client/.htaccess ./backup/client/

  #  save the server logs
  mv ./dist/server/logs/*.log ./backup/server/logs/

  # build the app
  npm run build

  # add the .shtml of 404
  cp ./dist/client/404.html ./dist/client/404.shtml

  # restore .htaccess for NodeJs application
  mv ./backup/client/.htaccess ./dist/client/

  # restore the server logs
  mv ./backup/server/logs/*.log ./dist/server/logs/

  # generate the node application entry point
  echo "import(\"./entry.mjs\");" > ./dist/server/entry.cjs

fi